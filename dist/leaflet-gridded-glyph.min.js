L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this.gridSize=t.gridSize,this.padding=t.padding,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.barColor=t.barColor||"blue",this.gridData=[]},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("zoomend moveend",this.onMapChange,this),t.on("mousemove",this.onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),t.off("zoomend moveend",this.onMapChange,this),t.off("mousemove",this.onMouseMove,this)},onMapChange:function(){var t=this._canvas,a=t.getContext("2d");a.clearRect(0,0,t.width,t.height);var i=this.geojsonLayer.getBounds();this.calculateGridData(i),this.drawGrid(a,i),this.drawCircles(a,i),this.customDrawFunction},onMouseMove:function(t){var a=t.containerPoint,i=this.geojsonLayer.getBounds(),n=this._map.latLngToContainerPoint(i.getNorthWest()),o=this._map.latLngToContainerPoint(i.getSouthEast()),e=this.gridSize;Math.ceil((o.x-n.x)/e),Math.ceil((o.y-n.y)/e);var s=e+this.padding;Math.floor((a.x-n.x)/s),Math.floor((a.y-n.y)/s)},calculateGridData:function(t){var a=this._map.latLngToContainerPoint(t.getNorthWest()),i=this._map.latLngToContainerPoint(t.getSouthEast()),n=this.gridSize,o=Math.ceil((i.x-a.x)/n),e=Math.ceil((i.y-a.y)/n);this.gridData=[];for(var s=0;s<e;s++){this.gridData[s]=[];for(var r=0;r<o;r++)this.gridData[s][r]={count:0,bounds:L.latLngBounds(this._map.containerPointToLatLng([a.x+r*(n+this.padding),a.y+s*(n+this.padding)]),this._map.containerPointToLatLng([a.x+(r+1)*(n+this.padding),a.y+(s+1)*(n+this.padding)]))}}var h=new rbush,d=[];this.geojsonLayer.eachLayer((function(t){var a=t.getLatLng();d.push({minX:a.lng,minY:a.lat,maxX:a.lng,maxY:a.lat,layer:t})})),h.load(d);for(s=0;s<e;s++)for(r=0;r<o;r++){var g=this.gridData[s][r].bounds,l=h.search({minX:g.getWest(),minY:g.getSouth(),maxX:g.getEast(),maxY:g.getNorth()});this.gridData[s][r].count=l.length}},drawGrid:function(t,a){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var i=this._map.latLngToContainerPoint(a.getNorthWest()),n=this._map.latLngToContainerPoint(a.getSouthEast()),o=this.gridSize,e=Math.ceil((n.x-i.x)/o),s=Math.ceil((n.y-i.y)/o),r=0;r<s;r++)for(var h=0;h<e;h++)this.gridData[r][h].count>0&&t.fillRect(i.x+h*(o+this.padding),i.y+r*(o+this.padding),o-this.padding,o-this.padding)},drawCircles:function(t,a){t.strokeStyle="black";for(var i=0;i<this.gridData.length;i++)for(var n=0;n<this.gridData[i].length;n++){var o=this.gridData[i][n],e=this._map.latLngToContainerPoint(o.bounds.getNorthWest()),s=this._map.latLngToContainerPoint(o.bounds.getSouthEast()),r=(e.x+s.x)/2,h=(e.y+s.y)/2,d=Math.min((s.x-e.x-this.padding)/2,(s.y-e.y-this.padding)/2),g=Math.min(5*o.count,d);t.beginPath(),t.arc(r,h,g,0,2*Math.PI),t.stroke()}},onDrawLayer:function(t){var a=t.canvas.getContext("2d"),i=this.geojsonLayer.getBounds();this.calculateGridData(i),this.drawGrid(a,i),this.drawCircles(a,i),this.customDrawFunction}}),L.griddedGlyph=function(t,a){return new L.GriddedGlyph(t,a)};
