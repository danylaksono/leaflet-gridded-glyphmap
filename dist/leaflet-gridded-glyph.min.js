function t(t,n,a,h,o){i(t,n,a||0,h||t.length-1,o||e)}function i(t,e,a,h,o){for(;h>a;){if(h-a>600){var r=h-a+1,s=e-a+1,l=Math.log(r),c=.5*Math.exp(2*l/3),d=.5*Math.sqrt(l*c*(r-c)/r)*(s-r/2<0?-1:1);i(t,e,Math.max(a,Math.floor(e-s*c/r+d)),Math.min(h,Math.floor(e+(r-s)*c/r+d)),o)}var m=t[e],u=a,g=h;for(n(t,a,e),o(t[h],m)>0&&n(t,a,h);u<g;){for(n(t,u,g),u++,g--;o(t[u],m)<0;)u++;for(;o(t[g],m)>0;)g--}0===o(t[a],m)?n(t,a,g):n(t,++g,h),g<=e&&(a=g+1),e<=g&&(h=g-1)}}function n(t,i,n){var e=t[i];t[i]=t[n],t[n]=e}function e(t,i){return t<i?-1:t>i?1:0}class a{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let i=this.data;const n=[];if(!f(t,i))return n;const e=this.toBBox,a=[];for(;i;){for(let h=0;h<i.children.length;h++){const o=i.children[h],r=i.leaf?e(o):o;f(t,r)&&(i.leaf?n.push(o):g(t,r)?this._all(o,n):a.push(o))}i=a.pop()}return n}collides(t){let i=this.data;if(!f(t,i))return!1;const n=[];for(;i;){for(let e=0;e<i.children.length;e++){const a=i.children[e],h=i.leaf?this.toBBox(a):a;if(f(t,h)){if(i.leaf||g(t,h))return!0;n.push(a)}}i=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){const t=this.data;this.data=i,i=t}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=x([]),this}remove(t,i){if(!t)return this;let n=this.data;const e=this.toBBox(t),a=[],o=[];let r,s,l;for(;n||a.length;){if(n||(n=a.pop(),s=a[a.length-1],r=o.pop(),l=!0),n.leaf){const e=h(t,n.children,i);if(-1!==e)return n.children.splice(e,1),a.push(n),this._condense(a),this}l||n.leaf||!g(n,e)?s?(r++,n=s.children[r],l=!1):n=null:(a.push(n),o.push(r),r=0,s=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,i){return t.minX-i.minX}compareMinY(t,i){return t.minY-i.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,i){const n=[];for(;t;)t.leaf?i.push(...t.children):n.push(...t.children),t=n.pop();return i}_build(t,i,n,e){const a=n-i+1;let h,r=this._maxEntries;if(a<=r)return h=x(t.slice(i,n+1)),o(h,this.toBBox),h;e||(e=Math.ceil(Math.log(a)/Math.log(r)),r=Math.ceil(a/Math.pow(r,e-1))),h=x([]),h.leaf=!1,h.height=e;const s=Math.ceil(a/r),l=s*Math.ceil(Math.sqrt(r));p(t,i,n,l,this.compareMinX);for(let a=i;a<=n;a+=l){const i=Math.min(a+l-1,n);p(t,a,i,s,this.compareMinY);for(let n=a;n<=i;n+=s){const a=Math.min(n+s-1,i);h.children.push(this._build(t,n,a,e-1))}}return o(h,this.toBBox),h}_chooseSubtree(t,i,n,e){for(;e.push(i),!i.leaf&&e.length-1!==n;){let n,e=1/0,o=1/0;for(let r=0;r<i.children.length;r++){const s=i.children[r],l=d(s),c=(a=t,h=s,(Math.max(h.maxX,a.maxX)-Math.min(h.minX,a.minX))*(Math.max(h.maxY,a.maxY)-Math.min(h.minY,a.minY))-l);c<o?(o=c,e=l<e?l:e,n=s):c===o&&l<e&&(e=l,n=s)}i=n||i.children[0]}var a,h;return i}_insert(t,i,n){const e=n?t:this.toBBox(t),a=[],h=this._chooseSubtree(e,this.data,i,a);for(h.children.push(t),s(h,e);i>=0&&a[i].children.length>this._maxEntries;)this._split(a,i),i--;this._adjustParentBBoxes(e,a,i)}_split(t,i){const n=t[i],e=n.children.length,a=this._minEntries;this._chooseSplitAxis(n,a,e);const h=this._chooseSplitIndex(n,a,e),r=x(n.children.splice(h,n.children.length-h));r.height=n.height,r.leaf=n.leaf,o(n,this.toBBox),o(r,this.toBBox),i?t[i-1].children.push(r):this._splitRoot(n,r)}_splitRoot(t,i){this.data=x([t,i]),this.data.height=t.height+1,this.data.leaf=!1,o(this.data,this.toBBox)}_chooseSplitIndex(t,i,n){let e,a=1/0,h=1/0;for(let o=i;o<=n-i;o++){const i=r(t,0,o,this.toBBox),s=r(t,o,n,this.toBBox),l=u(i,s),c=d(i)+d(s);l<a?(a=l,e=o,h=c<h?c:h):l===a&&c<h&&(h=c,e=o)}return e||n-i}_chooseSplitAxis(t,i,n){const e=t.leaf?this.compareMinX:l,a=t.leaf?this.compareMinY:c;this._allDistMargin(t,i,n,e)<this._allDistMargin(t,i,n,a)&&t.children.sort(e)}_allDistMargin(t,i,n,e){t.children.sort(e);const a=this.toBBox,h=r(t,0,i,a),o=r(t,n-i,n,a);let l=m(h)+m(o);for(let e=i;e<n-i;e++){const i=t.children[e];s(h,t.leaf?a(i):i),l+=m(h)}for(let e=n-i-1;e>=i;e--){const i=t.children[e];s(o,t.leaf?a(i):i),l+=m(o)}return l}_adjustParentBBoxes(t,i,n){for(let e=n;e>=0;e--)s(i[e],t)}_condense(t){for(let i,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():o(t[n],this.toBBox)}}function h(t,i,n){if(!n)return i.indexOf(t);for(let e=0;e<i.length;e++)if(n(t,i[e]))return e;return-1}function o(t,i){r(t,0,t.children.length,i,t)}function r(t,i,n,e,a){a||(a=x(null)),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let h=i;h<n;h++){const i=t.children[h];s(a,t.leaf?e(i):i)}return a}function s(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function l(t,i){return t.minX-i.minX}function c(t,i){return t.minY-i.minY}function d(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function m(t){return t.maxX-t.minX+(t.maxY-t.minY)}function u(t,i){const n=Math.max(t.minX,i.minX),e=Math.max(t.minY,i.minY),a=Math.min(t.maxX,i.maxX),h=Math.min(t.maxY,i.maxY);return Math.max(0,a-n)*Math.max(0,h-e)}function g(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function f(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function x(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(i,n,e,a,h){const o=[n,e];for(;o.length;){if((e=o.pop())-(n=o.pop())<=a)continue;const r=n+Math.ceil((e-n)/a/2)*a;t(i,r,n,e,h),o.push(n,r,r,e)}}L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this._tree=new a,this.gridSize=t.gridSize,this.padding=t.padding,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.barColor=t.barColor||"blue",this.gridData=[]},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("moveend",this._recalculateTree,this),t.on("zoomend moveend",this.onMapChange,this),t.on("mousemove",this.onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),t.off("moveend",this._recalculateTree,this),t.off("zoomend moveend",this.onMapChange,this),t.off("mousemove",this.onMouseMove,this)},onMapChange:function(){var t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var n=this.geojsonLayer.getBounds();this.calculateGridData(n),this.drawGrid(i,n),this.drawCircles(i,n),this.customDrawFunction},onMouseMove:function(t){var i=t.containerPoint,n=this.geojsonLayer.getBounds(),e=this._map.latLngToContainerPoint(n.getNorthWest()),a=this._map.latLngToContainerPoint(n.getSouthEast()),h=this.gridSize;Math.ceil((a.x-e.x)/h),Math.ceil((a.y-e.y)/h);var o=h+this.padding;Math.floor((i.x-e.x)/o),Math.floor((i.y-e.y)/o)},_recalculateTree:function(){this._tree.clear(),this.geojsonLayer.eachLayer((t=>{const i=t.getLatLng();this._tree.insert({minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,data:t})})),this._redraw()},calculateGridData:function(t){var i=this._map.latLngToContainerPoint(t.getNorthWest()),n=this._map.latLngToContainerPoint(t.getSouthEast()),e=this.gridSize,h=Math.ceil((n.x-i.x)/e),o=Math.ceil((n.y-i.y)/e);this.gridData=[];for(var r=0;r<o;r++){this.gridData[r]=[];for(var s=0;s<h;s++)this.gridData[r][s]={count:0,bounds:L.latLngBounds(this._map.containerPointToLatLng([i.x+s*(e+this.padding),i.y+r*(e+this.padding)]),this._map.containerPointToLatLng([i.x+(s+1)*(e+this.padding),i.y+(r+1)*(e+this.padding)]))}}var l=new a,c=[];this.geojsonLayer.eachLayer((function(t){var i=t.getLatLng();c.push({minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,layer:t})})),l.load(c);for(r=0;r<o;r++)for(s=0;s<h;s++){var d=this.gridData[r][s].bounds,m=l.search({minX:d.getWest(),minY:d.getSouth(),maxX:d.getEast(),maxY:d.getNorth()});this.gridData[r][s].count=m.length}},drawGrid:function(t,i){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var n=this._map.latLngToContainerPoint(i.getNorthWest()),e=this._map.latLngToContainerPoint(i.getSouthEast()),a=this.gridSize,h=Math.ceil((e.x-n.x)/a),o=Math.ceil((e.y-n.y)/a),r=0;r<o;r++)for(var s=0;s<h;s++)this.gridData[r][s].count>0&&t.fillRect(n.x+s*(a+this.padding),n.y+r*(a+this.padding),a-this.padding,a-this.padding)},drawCircles:function(t,i){t.strokeStyle="black";for(var n=0;n<this.gridData.length;n++)for(var e=0;e<this.gridData[n].length;e++){var a=this.gridData[n][e],h=this._map.latLngToContainerPoint(a.bounds.getNorthWest()),o=this._map.latLngToContainerPoint(a.bounds.getSouthEast()),r=(h.x+o.x)/2,s=(h.y+o.y)/2,l=Math.min((o.x-h.x-this.padding)/2,(o.y-h.y-this.padding)/2),c=Math.min(5*a.count,l);t.beginPath(),t.arc(r,s,c,0,2*Math.PI),t.stroke()}},onDrawLayer:function(t){var i=t.canvas.getContext("2d"),n=this.geojsonLayer.getBounds();this.calculateGridData(n),this.drawGrid(i,n),this.drawCircles(i,n),this.customDrawFunction},_redraw(){const t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const n=this.geojsonLayer.getBounds();this.calculateGridData(n),i.save(),this.drawGrid(i,n),i.restore(),i.save(),this.drawCircles(i,n),i.restore(),this.customDrawFunction&&this.customDrawFunction(i,n)}}),L.griddedGlyph=function(t,i){return new L.GriddedGlyph(t,i)};
