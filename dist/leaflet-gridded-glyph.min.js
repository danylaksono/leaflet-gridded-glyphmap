console.log(L),L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this.gridSize=t.gridSize,this.padding=t.padding,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.barColor=t.barColor||"blue",this.gridData=[]},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("zoomend moveend",this.onMapChange,this),t.on("mousemove",this.onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),t.off("zoomend moveend",this.onMapChange,this),t.off("mousemove",this.onMouseMove,this)},onMapChange:function(){var t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var a=this.geojsonLayer.getBounds();this.calculateGridData(a),this.drawGrid(i,a),this.drawCircles(i,a),this.customDrawFunction},onMouseMove:function(t){var i=t.containerPoint,a=this.geojsonLayer.getBounds(),o=this._map.latLngToContainerPoint(a.getNorthWest()),n=this._map.latLngToContainerPoint(a.getSouthEast()),e=this.gridSize,s=Math.ceil((n.x-o.x)/e),r=Math.ceil((n.y-o.y)/e),h=e+this.padding,d=Math.floor((i.x-o.x)/h),g=Math.floor((i.y-o.y)/h);g>=0&&g<r&&d>=0&&d<s&&(console.log("Grid cell:",g,d),console.log("Cell boundaries:",this.gridData[g][d].bounds.toBBoxString()))},calculateGridData:function(t){var i=this._map.latLngToContainerPoint(t.getNorthWest()),a=this._map.latLngToContainerPoint(t.getSouthEast()),o=this.gridSize,n=Math.ceil((a.x-i.x)/o),e=Math.ceil((a.y-i.y)/o);this.gridData=[];for(var s=0;s<e;s++){this.gridData[s]=[];for(var r=0;r<n;r++)this.gridData[s][r]={count:0,bounds:L.latLngBounds(this._map.containerPointToLatLng([i.x+r*(o+this.padding),i.y+s*(o+this.padding)]),this._map.containerPointToLatLng([i.x+(r+1)*(o+this.padding),i.y+(s+1)*(o+this.padding)]))}}var h=new Worker("worker.js");h.postMessage({gridData:this.gridData,features:this.geojsonLayer.toGeoJSON().features}),h.onmessage=function(t){this.gridData=t.data.gridData,h.terminate(),this.redraw()}.bind(this)},drawGrid:function(t,i){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var a=this._map.latLngToContainerPoint(i.getNorthWest()),o=this._map.latLngToContainerPoint(i.getSouthEast()),n=this.gridSize,e=Math.ceil((o.x-a.x)/n),s=Math.ceil((o.y-a.y)/n),r=0;r<s;r++)for(var h=0;h<e;h++)t.fillRect(a.x+h*(n+this.padding),a.y+r*(n+this.padding),n-this.padding,n-this.padding)},drawCircles:function(t,i){t.strokeStyle="black";for(var a=0;a<this.gridData.length;a++)for(var o=0;o<this.gridData[a].length;o++){var n=this.gridData[a][o],e=this._map.latLngToContainerPoint(n.bounds.getNorthWest()),s=this._map.latLngToContainerPoint(n.bounds.getSouthEast());console.log("northsouth",e,s);var r=(e.x+s.x)/2,h=(e.y+s.y)/2,d=5*n.count;t.beginPath(),t.arc(r,h,d,0,2*Math.PI),t.stroke()}},onDrawLayer:function(t){var i=t.canvas.getContext("2d"),a=this.geojsonLayer.getBounds();this.calculateGridData(a),this.drawGrid(i,a),this.drawCircles(i,a),this.customDrawFunction}}),L.griddedGlyph=function(t,i){return new L.GriddedGlyph(t,i)};
