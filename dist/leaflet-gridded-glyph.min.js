function t(t,e,n,h,r){i(t,e,n||0,h||t.length-1,r||a)}function i(t,a,n,h,r){for(;h>n;){if(h-n>600){var s=h-n+1,o=a-n+1,d=Math.log(s),c=.5*Math.exp(2*d/3),l=.5*Math.sqrt(d*c*(s-c)/s)*(o-s/2<0?-1:1);i(t,a,Math.max(n,Math.floor(a-o*c/s+l)),Math.min(h,Math.floor(a+(s-o)*c/s+l)),r)}var u=t[a],g=n,m=h;for(e(t,n,a),r(t[h],u)>0&&e(t,n,h);g<m;){for(e(t,g,m),g++,m--;r(t[g],u)<0;)g++;for(;r(t[m],u)>0;)m--}0===r(t[n],u)?e(t,n,m):e(t,++m,h),m<=a&&(n=m+1),a<=m&&(h=m-1)}}function e(t,i,e){var a=t[i];t[i]=t[e],t[e]=a}function a(t,i){return t<i?-1:t>i?1:0}class n{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let i=this.data;const e=[];if(!f(t,i))return e;const a=this.toBBox,n=[];for(;i;){for(let h=0;h<i.children.length;h++){const r=i.children[h],s=i.leaf?a(r):r;f(t,s)&&(i.leaf?e.push(r):m(t,s)?this._all(r,e):n.push(r))}i=n.pop()}return e}collides(t){let i=this.data;if(!f(t,i))return!1;const e=[];for(;i;){for(let a=0;a<i.children.length;a++){const n=i.children[a],h=i.leaf?this.toBBox(n):n;if(f(t,h)){if(i.leaf||m(t,h))return!0;e.push(n)}}i=e.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){const t=this.data;this.data=i,i=t}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=_([]),this}remove(t,i){if(!t)return this;let e=this.data;const a=this.toBBox(t),n=[],r=[];let s,o,d;for(;e||n.length;){if(e||(e=n.pop(),o=n[n.length-1],s=r.pop(),d=!0),e.leaf){const a=h(t,e.children,i);if(-1!==a)return e.children.splice(a,1),n.push(e),this._condense(n),this}d||e.leaf||!m(e,a)?o?(s++,e=o.children[s],d=!1):e=null:(n.push(e),r.push(s),s=0,o=e,e=e.children[0])}return this}toBBox(t){return t}compareMinX(t,i){return t.minX-i.minX}compareMinY(t,i){return t.minY-i.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,i){const e=[];for(;t;)t.leaf?i.push(...t.children):e.push(...t.children),t=e.pop();return i}_build(t,i,e,a){const n=e-i+1;let h,s=this._maxEntries;if(n<=s)return h=_(t.slice(i,e+1)),r(h,this.toBBox),h;a||(a=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/Math.pow(s,a-1))),h=_([]),h.leaf=!1,h.height=a;const o=Math.ceil(n/s),d=o*Math.ceil(Math.sqrt(s));p(t,i,e,d,this.compareMinX);for(let n=i;n<=e;n+=d){const i=Math.min(n+d-1,e);p(t,n,i,o,this.compareMinY);for(let e=n;e<=i;e+=o){const n=Math.min(e+o-1,i);h.children.push(this._build(t,e,n,a-1))}}return r(h,this.toBBox),h}_chooseSubtree(t,i,e,a){for(;a.push(i),!i.leaf&&a.length-1!==e;){let e,a=1/0,r=1/0;for(let s=0;s<i.children.length;s++){const o=i.children[s],d=l(o),c=(n=t,h=o,(Math.max(h.maxX,n.maxX)-Math.min(h.minX,n.minX))*(Math.max(h.maxY,n.maxY)-Math.min(h.minY,n.minY))-d);c<r?(r=c,a=d<a?d:a,e=o):c===r&&d<a&&(a=d,e=o)}i=e||i.children[0]}var n,h;return i}_insert(t,i,e){const a=e?t:this.toBBox(t),n=[],h=this._chooseSubtree(a,this.data,i,n);for(h.children.push(t),o(h,a);i>=0&&n[i].children.length>this._maxEntries;)this._split(n,i),i--;this._adjustParentBBoxes(a,n,i)}_split(t,i){const e=t[i],a=e.children.length,n=this._minEntries;this._chooseSplitAxis(e,n,a);const h=this._chooseSplitIndex(e,n,a),s=_(e.children.splice(h,e.children.length-h));s.height=e.height,s.leaf=e.leaf,r(e,this.toBBox),r(s,this.toBBox),i?t[i-1].children.push(s):this._splitRoot(e,s)}_splitRoot(t,i){this.data=_([t,i]),this.data.height=t.height+1,this.data.leaf=!1,r(this.data,this.toBBox)}_chooseSplitIndex(t,i,e){let a,n=1/0,h=1/0;for(let r=i;r<=e-i;r++){const i=s(t,0,r,this.toBBox),o=s(t,r,e,this.toBBox),d=g(i,o),c=l(i)+l(o);d<n?(n=d,a=r,h=c<h?c:h):d===n&&c<h&&(h=c,a=r)}return a||e-i}_chooseSplitAxis(t,i,e){const a=t.leaf?this.compareMinX:d,n=t.leaf?this.compareMinY:c;this._allDistMargin(t,i,e,a)<this._allDistMargin(t,i,e,n)&&t.children.sort(a)}_allDistMargin(t,i,e,a){t.children.sort(a);const n=this.toBBox,h=s(t,0,i,n),r=s(t,e-i,e,n);let d=u(h)+u(r);for(let a=i;a<e-i;a++){const i=t.children[a];o(h,t.leaf?n(i):i),d+=u(h)}for(let a=e-i-1;a>=i;a--){const i=t.children[a];o(r,t.leaf?n(i):i),d+=u(r)}return d}_adjustParentBBoxes(t,i,e){for(let a=e;a>=0;a--)o(i[a],t)}_condense(t){for(let i,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():r(t[e],this.toBBox)}}function h(t,i,e){if(!e)return i.indexOf(t);for(let a=0;a<i.length;a++)if(e(t,i[a]))return a;return-1}function r(t,i){s(t,0,t.children.length,i,t)}function s(t,i,e,a,n){n||(n=_(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let h=i;h<e;h++){const i=t.children[h];o(n,t.leaf?a(i):i)}return n}function o(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function d(t,i){return t.minX-i.minX}function c(t,i){return t.minY-i.minY}function l(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function g(t,i){const e=Math.max(t.minX,i.minX),a=Math.max(t.minY,i.minY),n=Math.min(t.maxX,i.maxX),h=Math.min(t.maxY,i.maxY);return Math.max(0,n-e)*Math.max(0,h-a)}function m(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function f(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function _(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(i,e,a,n,h){const r=[e,a];for(;r.length;){if((a=r.pop())-(e=r.pop())<=n)continue;const s=e+Math.ceil((a-e)/n/2)*n;t(i,s,e,a,h),r.push(e,s,s,a)}}L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this._tree=new n,this.options=t||{},this.gridSize=t.gridSize||20,this.padding=t.padding||5,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.gridType=t.gridType||"square",this.debug=t.debug||!1,this.gridData=[],this._cachedBounds=null,this._cachedZoom=null,this._cachedGridSize=null,this._cachedPadding=null,this._cachedGridType=null,this._dataHash=null,this._cachedGridOriginX=null,this._cachedGridOriginY=null},_generateDataHash:function(){if(!this.geojsonLayer)return null;let t=0,i=0;return this.geojsonLayer.eachLayer((e=>{const a=e.getLatLng();t=(t<<5)-t+a.lat+a.lng&4294967295,i++})),t+"_"+i},_needsRecalculation:function(t){const i=this._map.getZoom(),e=this._generateDataHash(),a=this._map.latLngToContainerPoint(t.getNorthWest()),n=Math.floor(a.x/this.gridSize)*this.gridSize,h=Math.floor(a.y/this.gridSize)*this.gridSize,r=this._cachedGridOriginX!==n||this._cachedGridOriginY!==h,s=this._cachedZoom!==i,o=this._cachedGridSize!==this.gridSize,d=this._cachedPadding!==this.padding,c=this._cachedGridType!==this.gridType,l=this._dataHash!==e;return r||s||o||d||c||l},_updateCache:function(t){const i=this._map.latLngToContainerPoint(t.getNorthWest());this._cachedGridOriginX=Math.floor(i.x/this.gridSize)*this.gridSize,this._cachedGridOriginY=Math.floor(i.y/this.gridSize)*this.gridSize,this._cachedBounds=t,this._cachedZoom=this._map.getZoom(),this._cachedGridSize=this.gridSize,this._cachedPadding=this.padding,this._cachedGridType=this.gridType,this._dataHash=this._generateDataHash()},invalidateCache:function(){this._cachedBounds=null,this._cachedZoom=null,this._cachedGridSize=null,this._cachedPadding=null,this._cachedGridType=null,this._dataHash=null,this._cachedGridOriginX=null,this._cachedGridOriginY=null},getCacheStats:function(){return{hasCachedBounds:!!this._cachedBounds,cachedZoom:this._cachedZoom,cachedGridSize:this._cachedGridSize,cachedPadding:this._cachedPadding,cachedGridType:this._cachedGridType,dataHash:this._dataHash,currentDataHash:this._generateDataHash(),gridDataLength:this.gridData.length}},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("zoomend moveend",this._redraw,this),t.on("mousemove",this._onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),this._tree.clear(),this.gridData=[],this._cachedBounds=null,t.off("zoomend moveend",this._redraw,this),t.off("mousemove",this._onMouseMove,this)},_onMouseMove:function(t){var i=t.containerPoint;this._findCellByCoords(i)},_findCellByCoords:function(t){for(var i=0;i<this.gridData.length;i++)for(var e=0;e<this.gridData[i].length;e++){var a=this.gridData[i][e];if(t.x>=a.x&&t.x<=a.x+this.gridSize&&t.y>=a.y&&t.y<=a.y+this.gridSize)return a}return null},_recalculateTree:function(){this._tree.clear(),this.geojsonLayer.eachLayer((t=>{const i=t.getLatLng();this._tree.insert({minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,data:t})}))},calculateGridData:function(t){this._needsRecalculation(t)?(this.options.debug&&console.log("Grid data cache miss - recalculating"),"square"===this.gridType?this._calculateSquareGridData(t):"hexagon"===this.gridType||"h3"===this.gridType||this.gridType,this._updateCache(t)):this.options.debug&&console.log("Grid data cache hit - using cached data")},_calculateSquareGridData:function(t){var i=this._map.latLngToContainerPoint(t.getNorthWest()),e=this._map.latLngToContainerPoint(t.getSouthEast()),a=this.gridSize,n=Math.ceil((e.x-i.x)/a),h=Math.ceil((e.y-i.y)/a);this.gridData=[];for(var r=0;r<h;r++){this.gridData[r]=[];for(var s=0;s<n;s++){var o=i.x+s*(a+this.padding),d=i.y+r*(a+this.padding);this.gridData[r][s]={count:0,x:o,y:d,bounds:L.latLngBounds(this._map.containerPointToLatLng([o,d]),this._map.containerPointToLatLng([o+a+this.padding,d+a+this.padding])),attributes:[]}}}this._tree&&0!==this._tree.all().length&&this._dataHash===this._generateDataHash()||this._recalculateTree();for(r=0;r<h;r++)for(s=0;s<n;s++){var c=this.gridData[r][s].bounds,l=this._tree.search({minX:c.getWest(),minY:c.getSouth(),maxX:c.getEast(),maxY:c.getNorth()});this.gridData[r][s].count=l.length;var u=this.gridData[r][s];for(const t of l)u.attributes.push(t.data.feature.properties)}},drawGrid:function(t,i){"square"===this.gridType?this._drawSquareGrid(t,i):this.gridType},_drawSquareGrid:function(t,i){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var e=0;e<this.gridData.length;e++)for(var a=0;a<this.gridData[e].length;a++)this.gridData[e][a].count>0&&t.fillRect(this.gridData[e][a].x,this.gridData[e][a].y,this.gridSize-this.padding,this.gridSize-this.padding)},drawGlyphs:function(t,i){for(var e=0;e<this.gridData.length;e++)for(var a=0;a<this.gridData[e].length;a++){var n=this.gridData[e][a],h=this._map.latLngToContainerPoint(n.bounds.getNorthWest()),r=this._map.latLngToContainerPoint(n.bounds.getSouthEast()),s=(h.x+r.x)/2,o=(h.y+r.y)/2;this.customDrawFunction?this.customDrawFunction(t,n,s,o):this._drawCircleGlyph(t,n,s,o)}},_drawCircleGlyph:function(t,i,e,a){t.strokeStyle="black";var n=this.gridSize/2-this.padding,h=Math.min(5*i.count,n);t.beginPath(),t.arc(e,a,h,0,2*Math.PI),t.stroke()},onDrawLayer:function(t){var i=t.canvas.getContext("2d"),e=this.geojsonLayer.getBounds();this.calculateGridData(e),this.drawGrid(i,e),this.drawGlyphs(i,e)},_redraw:function(){const t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const e=this.geojsonLayer.getBounds();this.calculateGridData(e),i.save(),this.drawGrid(i,e),i.restore(),i.save(),this.drawGlyphs(i,e),i.restore()}}),L.griddedGlyph=function(t){return new L.GriddedGlyph(t)},"undefined"!=typeof window&&(window.L=window.L||{},window.L.GriddedGlyph=L.GriddedGlyph,window.L.griddedGlyph=L.griddedGlyph);
