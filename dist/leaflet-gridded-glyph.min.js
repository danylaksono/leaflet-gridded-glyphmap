function t(t,n,e,h,r){i(t,n,e||0,h||t.length-1,r||a)}function i(t,a,e,h,r){for(;h>e;){if(h-e>600){var o=h-e+1,s=a-e+1,l=Math.log(o),c=.5*Math.exp(2*l/3),d=.5*Math.sqrt(l*c*(o-c)/o)*(s-o/2<0?-1:1);i(t,a,Math.max(e,Math.floor(a-s*c/o+d)),Math.min(h,Math.floor(a+(o-s)*c/o+d)),r)}var m=t[a],u=e,g=h;for(n(t,e,a),r(t[h],m)>0&&n(t,e,h);u<g;){for(n(t,u,g),u++,g--;r(t[u],m)<0;)u++;for(;r(t[g],m)>0;)g--}0===r(t[e],m)?n(t,e,g):n(t,++g,h),g<=a&&(e=g+1),a<=g&&(h=g-1)}}function n(t,i,n){var a=t[i];t[i]=t[n],t[n]=a}function a(t,i){return t<i?-1:t>i?1:0}class e{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let i=this.data;const n=[];if(!f(t,i))return n;const a=this.toBBox,e=[];for(;i;){for(let h=0;h<i.children.length;h++){const r=i.children[h],o=i.leaf?a(r):r;f(t,o)&&(i.leaf?n.push(r):g(t,o)?this._all(r,n):e.push(r))}i=e.pop()}return n}collides(t){let i=this.data;if(!f(t,i))return!1;const n=[];for(;i;){for(let a=0;a<i.children.length;a++){const e=i.children[a],h=i.leaf?this.toBBox(e):e;if(f(t,h)){if(i.leaf||g(t,h))return!0;n.push(e)}}i=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){const t=this.data;this.data=i,i=t}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=x([]),this}remove(t,i){if(!t)return this;let n=this.data;const a=this.toBBox(t),e=[],r=[];let o,s,l;for(;n||e.length;){if(n||(n=e.pop(),s=e[e.length-1],o=r.pop(),l=!0),n.leaf){const a=h(t,n.children,i);if(-1!==a)return n.children.splice(a,1),e.push(n),this._condense(e),this}l||n.leaf||!g(n,a)?s?(o++,n=s.children[o],l=!1):n=null:(e.push(n),r.push(o),o=0,s=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,i){return t.minX-i.minX}compareMinY(t,i){return t.minY-i.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,i){const n=[];for(;t;)t.leaf?i.push(...t.children):n.push(...t.children),t=n.pop();return i}_build(t,i,n,a){const e=n-i+1;let h,o=this._maxEntries;if(e<=o)return h=x(t.slice(i,n+1)),r(h,this.toBBox),h;a||(a=Math.ceil(Math.log(e)/Math.log(o)),o=Math.ceil(e/Math.pow(o,a-1))),h=x([]),h.leaf=!1,h.height=a;const s=Math.ceil(e/o),l=s*Math.ceil(Math.sqrt(o));p(t,i,n,l,this.compareMinX);for(let e=i;e<=n;e+=l){const i=Math.min(e+l-1,n);p(t,e,i,s,this.compareMinY);for(let n=e;n<=i;n+=s){const e=Math.min(n+s-1,i);h.children.push(this._build(t,n,e,a-1))}}return r(h,this.toBBox),h}_chooseSubtree(t,i,n,a){for(;a.push(i),!i.leaf&&a.length-1!==n;){let n,a=1/0,r=1/0;for(let o=0;o<i.children.length;o++){const s=i.children[o],l=d(s),c=(e=t,h=s,(Math.max(h.maxX,e.maxX)-Math.min(h.minX,e.minX))*(Math.max(h.maxY,e.maxY)-Math.min(h.minY,e.minY))-l);c<r?(r=c,a=l<a?l:a,n=s):c===r&&l<a&&(a=l,n=s)}i=n||i.children[0]}var e,h;return i}_insert(t,i,n){const a=n?t:this.toBBox(t),e=[],h=this._chooseSubtree(a,this.data,i,e);for(h.children.push(t),s(h,a);i>=0&&e[i].children.length>this._maxEntries;)this._split(e,i),i--;this._adjustParentBBoxes(a,e,i)}_split(t,i){const n=t[i],a=n.children.length,e=this._minEntries;this._chooseSplitAxis(n,e,a);const h=this._chooseSplitIndex(n,e,a),o=x(n.children.splice(h,n.children.length-h));o.height=n.height,o.leaf=n.leaf,r(n,this.toBBox),r(o,this.toBBox),i?t[i-1].children.push(o):this._splitRoot(n,o)}_splitRoot(t,i){this.data=x([t,i]),this.data.height=t.height+1,this.data.leaf=!1,r(this.data,this.toBBox)}_chooseSplitIndex(t,i,n){let a,e=1/0,h=1/0;for(let r=i;r<=n-i;r++){const i=o(t,0,r,this.toBBox),s=o(t,r,n,this.toBBox),l=u(i,s),c=d(i)+d(s);l<e?(e=l,a=r,h=c<h?c:h):l===e&&c<h&&(h=c,a=r)}return a||n-i}_chooseSplitAxis(t,i,n){const a=t.leaf?this.compareMinX:l,e=t.leaf?this.compareMinY:c;this._allDistMargin(t,i,n,a)<this._allDistMargin(t,i,n,e)&&t.children.sort(a)}_allDistMargin(t,i,n,a){t.children.sort(a);const e=this.toBBox,h=o(t,0,i,e),r=o(t,n-i,n,e);let l=m(h)+m(r);for(let a=i;a<n-i;a++){const i=t.children[a];s(h,t.leaf?e(i):i),l+=m(h)}for(let a=n-i-1;a>=i;a--){const i=t.children[a];s(r,t.leaf?e(i):i),l+=m(r)}return l}_adjustParentBBoxes(t,i,n){for(let a=n;a>=0;a--)s(i[a],t)}_condense(t){for(let i,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():r(t[n],this.toBBox)}}function h(t,i,n){if(!n)return i.indexOf(t);for(let a=0;a<i.length;a++)if(n(t,i[a]))return a;return-1}function r(t,i){o(t,0,t.children.length,i,t)}function o(t,i,n,a,e){e||(e=x(null)),e.minX=1/0,e.minY=1/0,e.maxX=-1/0,e.maxY=-1/0;for(let h=i;h<n;h++){const i=t.children[h];s(e,t.leaf?a(i):i)}return e}function s(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function l(t,i){return t.minX-i.minX}function c(t,i){return t.minY-i.minY}function d(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function m(t){return t.maxX-t.minX+(t.maxY-t.minY)}function u(t,i){const n=Math.max(t.minX,i.minX),a=Math.max(t.minY,i.minY),e=Math.min(t.maxX,i.maxX),h=Math.min(t.maxY,i.maxY);return Math.max(0,e-n)*Math.max(0,h-a)}function g(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function f(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function x(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(i,n,a,e,h){const r=[n,a];for(;r.length;){if((a=r.pop())-(n=r.pop())<=e)continue;const o=n+Math.ceil((a-n)/e/2)*e;t(i,o,n,a,h),r.push(n,o,o,a)}}L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this._tree=new e,this.gridSize=t.gridSize,this.padding=t.padding,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.gridData=[]},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("moveend",this._recalculateTree,this),t.on("zoomend moveend",this.onMapChange,this),t.on("mousemove",this.onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),t.off("moveend",this._recalculateTree,this),t.off("zoomend moveend",this.onMapChange,this),t.off("mousemove",this.onMouseMove,this)},onMapChange:function(){var t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var n=this.geojsonLayer.getBounds();this.calculateGridData(n),this.drawGrid(i,n),this.drawCircles(i,n),this.customDrawFunction},onMouseMove:function(t){var i=t.containerPoint,n=this.geojsonLayer.getBounds(),a=this._map.latLngToContainerPoint(n.getNorthWest()),e=this._map.latLngToContainerPoint(n.getSouthEast()),h=this.gridSize;Math.ceil((e.x-a.x)/h),Math.ceil((e.y-a.y)/h);var r=h+this.padding;Math.floor((i.x-a.x)/r),Math.floor((i.y-a.y)/r)},_recalculateTree:function(){this._tree.clear(),this.geojsonLayer.eachLayer((t=>{const i=t.getLatLng();this._tree.insert({minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,data:t})})),this._redraw()},calculateGridData:function(t){var i=this._map.latLngToContainerPoint(t.getNorthWest()),n=this._map.latLngToContainerPoint(t.getSouthEast()),a=this.gridSize,h=Math.ceil((n.x-i.x)/a),r=Math.ceil((n.y-i.y)/a);this.gridData=[];for(var o=0;o<r;o++){this.gridData[o]=[];for(var s=0;s<h;s++)this.gridData[o][s]={count:0,bounds:L.latLngBounds(this._map.containerPointToLatLng([i.x+s*(a+this.padding),i.y+o*(a+this.padding)]),this._map.containerPointToLatLng([i.x+(s+1)*(a+this.padding),i.y+(o+1)*(a+this.padding)])),attributes:[]}}var l=new e,c=[];this.geojsonLayer.eachLayer((function(t){var i=t.getLatLng();c.push({minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,layer:t,data:t.feature.properties})})),l.load(c);for(o=0;o<r;o++)for(s=0;s<h;s++){var d=this.gridData[o][s].bounds,m=l.search({minX:d.getWest(),minY:d.getSouth(),maxX:d.getEast(),maxY:d.getNorth()});this.gridData[o][s].count=m.length,cellData=this.gridData[o][s];for(const t of m)cellData.attributes.push(t.data.properties)}},drawGrid:function(t,i){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var n=this._map.latLngToContainerPoint(i.getNorthWest()),a=this._map.latLngToContainerPoint(i.getSouthEast()),e=this.gridSize,h=Math.ceil((a.x-n.x)/e),r=Math.ceil((a.y-n.y)/e),o=0;o<r;o++)for(var s=0;s<h;s++)this.gridData[o][s].count>0&&t.fillRect(n.x+s*(e+this.padding),n.y+o*(e+this.padding),e-this.padding,e-this.padding)},drawCircles:function(t,i){t.strokeStyle="black";for(var n=0;n<this.gridData.length;n++)for(var a=0;a<this.gridData[n].length;a++){var e=this.gridData[n][a];console.log("Grid data: ",e.attributes);var h=this._map.latLngToContainerPoint(e.bounds.getNorthWest()),r=this._map.latLngToContainerPoint(e.bounds.getSouthEast()),o=(h.x+r.x)/2-this.padding,s=(h.y+r.y)/2-this.padding,l=Math.min((r.x-h.x-2*this.padding)/2,(r.y-h.y-2*this.padding)/2),c=Math.min(5*e.count,l);t.beginPath(),t.arc(o,s,c,0,2*Math.PI),t.stroke()}},onDrawLayer:function(t){var i=t.canvas.getContext("2d"),n=this.geojsonLayer.getBounds();this.calculateGridData(n),this.drawGrid(i,n),this.drawCircles(i,n),this.customDrawFunction},_redraw(){const t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const n=this.geojsonLayer.getBounds();this.calculateGridData(n),i.save(),this.drawGrid(i,n),i.restore(),i.save(),this.drawCircles(i,n),i.restore(),this.customDrawFunction&&this.customDrawFunction(i,n)}}),L.griddedGlyph=function(t,i){return new L.GriddedGlyph(t,i)};
