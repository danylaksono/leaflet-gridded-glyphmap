console.log(L),L.GriddedGlyph=L.CanvasLayer.extend({initialize:function(t){L.CanvasLayer.prototype.initialize.call(this,t),this.gridSize=t.gridSize,this.padding=t.padding,this.geojsonLayer=t.geojsonLayer,this.customDrawFunction=t.customDrawFunction,this.barColor=t.barColor||"blue",this.gridData=[]},onAdd:function(t){L.CanvasLayer.prototype.onAdd.call(this,t),t.on("zoomend moveend",this.onMapChange,this),t.on("mousemove",this.onMouseMove,this)},onRemove:function(t){L.CanvasLayer.prototype.onRemove.call(this,t),t.off("zoomend moveend",this.onMapChange,this),t.off("mousemove",this.onMouseMove,this)},onMapChange:function(){var t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var o=this.geojsonLayer.getBounds();this.calculateGridData(o),this.drawGrid(i,o),this.drawCircles(i,o),this.customDrawFunction},onMouseMove:function(t){var i=t.containerPoint,o=this.geojsonLayer.getBounds(),a=this._map.latLngToContainerPoint(o.getNorthWest()),n=this._map.latLngToContainerPoint(o.getSouthEast()),e=this.gridSize,s=Math.ceil((n.x-a.x)/e),r=Math.ceil((n.y-a.y)/e),h=e+this.padding,d=Math.floor((i.x-a.x)/h),g=Math.floor((i.y-a.y)/h);g>=0&&g<r&&d>=0&&d<s&&(console.log("Grid cell:",g,d),console.log("Cell boundaries:",this.gridData[g][d].bounds.toBBoxString()))},calculateGridData:function(t){var i=this._map.latLngToContainerPoint(t.getNorthWest()),o=this._map.latLngToContainerPoint(t.getSouthEast()),a=this.gridSize,n=Math.ceil((o.x-i.x)/a),e=Math.ceil((o.y-i.y)/a);this.gridData=[];for(var s=0;s<e;s++){this.gridData[s]=[];for(var r=0;r<n;r++)this.gridData[s][r]={count:0,bounds:L.latLngBounds(this._map.containerPointToLatLng([i.x+r*(a+this.padding),i.y+s*(a+this.padding)]),this._map.containerPointToLatLng([i.x+(r+1)*(a+this.padding),i.y+(s+1)*(a+this.padding)]))}}var h=this.gridData;this.geojsonLayer.eachLayer((function(t){for(var i=0;i<e;i++)for(var o=0;o<n;o++)h[i][o].bounds.contains(t.getLatLng())&&h[i][o].count++}))},drawGrid:function(t,i){t.fillStyle="rgba(255, 0, 0, 0.5)";for(var o=this._map.latLngToContainerPoint(i.getNorthWest()),a=this._map.latLngToContainerPoint(i.getSouthEast()),n=this.gridSize,e=Math.ceil((a.x-o.x)/n),s=Math.ceil((a.y-o.y)/n),r=0;r<s;r++)for(var h=0;h<e;h++)t.fillRect(o.x+h*(n+this.padding),o.y+r*(n+this.padding),n-this.padding,n-this.padding)},drawCircles:function(t,i){t.strokeStyle="black";for(var o=0;o<this.gridData.length;o++)for(var a=0;a<this.gridData[o].length;a++){var n=this.gridData[o][a],e=this._map.latLngToContainerPoint(n.bounds.getNorthWest()),s=this._map.latLngToContainerPoint(n.bounds.getSouthEast());console.log("northsouth",e,s);var r=(e.x+s.x)/2,h=(e.y+s.y)/2,d=5*n.count;t.beginPath(),t.arc(r,h,d,0,2*Math.PI),t.stroke()}},onDrawLayer:function(t){var i=t.canvas.getContext("2d"),o=this.geojsonLayer.getBounds();this.calculateGridData(o),this.drawGrid(i,o),this.drawCircles(i,o),this.customDrawFunction}}),L.griddedGlyph=function(t,i){return new L.GriddedGlyph(t,i)};
